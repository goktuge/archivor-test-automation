# E2E Tests - Playwright
# Required secrets: TEST_USER_EMAIL, TEST_USER_PASSWORD
# Optional: STAGING_URL, PROD_URL, INFLUX_CLOUD_URL, INFLUX_CLOUD_TOKEN, INFLUX_CLOUD_ORG

name: E2E Tests

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression

env:
  CI: true
  INFLUX_URL: ${{ secrets.INFLUX_CLOUD_URL }}
  INFLUX_TOKEN: ${{ secrets.INFLUX_CLOUD_TOKEN }}
  INFLUX_ORG: ${{ secrets.INFLUX_CLOUD_ORG }}
  INFLUX_BUCKET: test-metrics

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-unauth, chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.project == 'chromium-unauth' && 'chromium' || matrix.project }}

      - name: Run smoke tests
        run: npx playwright test tests --grep=@smoke --project=${{ matrix.project }}
        continue-on-error: true
        env:
          ENV: staging
          BASE_URL: ${{ secrets.STAGING_URL || 'https://app.staging.archivor.io' }}
          HEADLESS: true
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.project }}
          path: |
            allure-results/
            test-results/

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-unauth, chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.project == 'chromium-unauth' && 'chromium' || matrix.project }}

      - name: Run regression tests
        run: npx playwright test tests --grep=@e2e --project=${{ matrix.project }}
        continue-on-error: true
        env:
          ENV: prod
          BASE_URL: ${{ secrets.PROD_URL || secrets.STAGING_URL || 'https://app.staging.archivor.io' }}
          HEADLESS: true
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.project }}
          path: |
            allure-results/
            test-results/

  manual-trigger:
    name: Manual Test Run
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-unauth, chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.project == 'chromium-unauth' && 'chromium' || matrix.project }}

      - name: Run tests
        run: |
          if [ "${{ github.event.inputs.test_type }}" == "smoke" ]; then
            npx playwright test tests --grep=@smoke --project=${{ matrix.project }}
          else
            npx playwright test tests --project=${{ matrix.project }}
          fi
        continue-on-error: true
        env:
          ENV: ${{ github.event.inputs.environment }}
          BASE_URL: ${{ github.event.inputs.environment == 'prod' && secrets.PROD_URL || secrets.STAGING_URL || 'https://app.staging.archivor.io' }}
          HEADLESS: true
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.project }}
          path: |
            allure-results/
            test-results/

  report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests, manual-trigger]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false

      - name: Checkout gh-pages (history)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Merge results
        run: |
          mkdir -p allure-results
          if [ -d artifacts ]; then
            find artifacts -name "*.json" -exec cp {} allure-results/ \; 2>/dev/null || true
            find artifacts -type f \( -name "*.webm" -o -name "*.png" -o -name "*.jpg" -o -name "*.zip" \) -exec cp {} allure-results/ \; 2>/dev/null || true
          fi

      - name: Generate Allure
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history
          keep_reports: 20
        continue-on-error: true

      - name: Deploy Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: allure-history
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true
          single-commit: true
        continue-on-error: true

      - name: Upload allure-results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload allure-report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          if-no-files-found: ignore
          retention-days: 14
