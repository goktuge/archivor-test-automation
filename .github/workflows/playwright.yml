# Playwright Tests CI
# Required secrets: TEST_USER_EMAIL, TEST_USER_PASSWORD (for auth-dependent tests)
# Add in: Settings > Secrets and variables > Actions

name: Playwright Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - full

env:
  CI: true
  BASE_URL: https://app.staging.archivor.io

jobs:
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' && (github.event_name != 'workflow_dispatch' || github.event.inputs.test_suite == 'smoke' || github.event.inputs.test_suite == 'full')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright browsers (cache hit)
        if: steps.cache-playwright.outputs.cache-hit == 'true'
        run: npx playwright install chromium

      - name: Run smoke tests
        run: npm run test:smoke -- --project=chromium
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CI: ${{ env.CI }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload allure-results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-allure-results
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload playwright-report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: smoke-playwright-report
          path: playwright-report/
          retention-days: 7

  regression:
    name: Regression Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.test_suite == 'regression' || github.event.inputs.test_suite == 'full'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright browsers (cache hit)
        if: steps.cache-playwright.outputs.cache-hit == 'true'
        run: npx playwright install chromium

      - name: Run regression tests
        run: npm run test:regression -- --project=chromium
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CI: ${{ env.CI }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload allure-results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-allure-results
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload playwright-report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: regression-playwright-report
          path: playwright-report/
          retention-days: 14

  test:
    name: Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' && (github.event_name != 'workflow_dispatch' || github.event.inputs.test_suite == 'full')
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Install Playwright browsers (cache hit)
        if: steps.cache-playwright.outputs.cache-hit == 'true'
        run: npx playwright install ${{ matrix.browser }}

      - name: Run tests
        run: npm run test -- --project=${{ matrix.browser }}
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CI: ${{ env.CI }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload allure-results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload playwright-report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7

  report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [smoke, regression, test]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false

      - name: Checkout gh-pages (history)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Merge results
        run: |
          mkdir -p allure-results
          if [ -d artifacts ]; then
            find artifacts -name "*.json" -exec cp {} allure-results/ \; 2>/dev/null || true
            find artifacts -type f \( -name "*.webm" -o -name "*.png" -o -name "*.jpg" -o -name "*.zip" \) -exec cp {} allure-results/ \; 2>/dev/null || true
          fi

      - name: Generate Allure
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history
          keep_reports: 20
        continue-on-error: true

      - name: Deploy Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: allure-history
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true
          single-commit: true
        continue-on-error: true

      - name: Upload allure-results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload allure-report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          if-no-files-found: ignore
          retention-days: 14
